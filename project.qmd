
```{python}
import pandas as pd
import requests
import re
from io import StringIO
```

```{python}
url = "https://wgiserver.org/v1/seasonapi%3Dpvk7syNgSZbCyTtTf_tWAw" #json link from the WGI historical scores for 2025 percussion
params = {
    "Division": "perc",
    "SeasonId": "a0sUy0000007hTFIAY"  # 2025 Season ID
}

r = requests.get(url, params=params)
data = r.json()

jsondf = pd.DataFrame(data)

jsondf = jsondf[~jsondf.Name.str.contains("Concert|PSC", case=False, na=False)]


recap_urls = (
    jsondf["RecapURL"]         # remove missing links
    .unique()          # deduplicate
    .tolist()          # convert to Python list
)
date_lookup = jsondf.set_index("RecapURL")["Show_Date__c"].to_dict()
len(recap_urls)
```

```{python}
#set up for loop cell
cleaned_tables = []

# Set the columns

master_col = [
    "group","location",

    # Effect Music (1 & 2)
    "effect_music_1_ovr","effect_music_1_mus","effect_music_1_tot",
    "effect_music_2_ovr","effect_music_2_mus","effect_music_2_tot",
    "effect_music_total",

    # Effect Visual (1 & 2)
    "effect_visual_1_ovr","effect_visual_1_vis","effect_visual_1_tot",
    "effect_visual_2_ovr","effect_visual_2_vis","effect_visual_2_tot",
    "effect_visual_total",

    # Music (1 & 2)
    "music_1_comp","music_1_perf","music_1_tot",
    "music_2_comp","music_2_perf","music_2_tot",
    "music_total",

    # Visual (1 & 2)
    "visual_1_comp","visual_1_perf","visual_1_tot",
    "visual_2_comp","visual_2_perf","visual_2_tot",
    "visual_total",

    # Summary
    "sub_total","penalties","total",

    # Judge name columns
    "effect_music_1_judge","effect_music_2_judge",
    "effect_visual_1_judge","effect_visual_2_judge",
    "music_1_judge","music_2_judge",
    "visual_1_judge","visual_2_judge",

    # Metadata
    "class"
]
```

```{python}
# beginng of the loop 

for url in recap_urls:
    print(f"loading... {url}")

    # preset the rank in to parentheses for later deperation
    html = requests.get(url).text
    html = re.sub(r"(?<=content rank\'>)(\d+)", r'(\1)', html)

    tables = pd.read_html(StringIO(html), match="Visual") #helped limit the searches for marching only (ended up needing more because winds slipped in)

    # limit tables to only be marching percussion
    for idx in range(1, len(tables), 2):

        raw = tables[idx]             # scoring table
        class_table = tables[idx - 1] # class table immediately before used for helping determine the class of the group 

        # Correct class extraction (class is basically the skill group with world class being the highest level of skill)
        event_class = class_table.iloc[0,0]
        print(f"Class: {event_class}")

        # Determine table type
        is_large = raw.shape[1] > 20

        expected_small = 17
        expected_large = 33 #these are the two standard sizings for either single or double pannel judging

        if raw.shape[1] not in (expected_small, expected_large):
            print(f"Skipping table â€” unexpected column count: {raw.shape[1]}")
            continue #skips this raw table if it does not meet the standard table sizings removing things like winds.

        # Extracts header row (judge names)
        header1 = raw.iloc[1]

        # Remove header rows
        df = raw.iloc[3:].reset_index(drop=True)

        # large panel (two judges per category)

        if is_large:
            print("It's a large table") #just used for seeign progress and identifying problem tables

            df.columns = [
                "group","location",

                # Effect Music
                "effect_music_1_ovr","effect_music_1_mus","effect_music_1_tot",
                "effect_music_2_ovr","effect_music_2_mus","effect_music_2_tot",
                "effect_music_total",

                # Effect Visual
                "effect_visual_1_ovr","effect_visual_1_vis","effect_visual_1_tot",
                "effect_visual_2_ovr","effect_visual_2_vis","effect_visual_2_tot",
                "effect_visual_total",

                # Music
                "music_1_comp","music_1_perf","music_1_tot",
                "music_2_comp","music_2_perf","music_2_tot",
                "music_total",

                # Visual
                "visual_1_comp","visual_1_perf","visual_1_tot",
                "visual_2_comp","visual_2_perf","visual_2_tot",
                "visual_total",

                # Summary
                "sub_total","penalties","total"
            ]

            # judge name columns
            df["effect_music_1_judge"]  = header1[2]
            df["effect_music_2_judge"]  = header1[5]
            df["effect_visual_1_judge"] = header1[9]
            df["effect_visual_2_judge"] = header1[12]
            df["music_1_judge"]         = header1[16]
            df["music_2_judge"]         = header1[19]
            df["visual_1_judge"]        = header1[23]
            df["visual_2_judge"]        = header1[26]

        # Small panel (one judge per category)
        else:
            print("It's a small table")

            df.columns = [
                "group","location",

                "effect_music_1_ovr","effect_music_1_mus","effect_music_1_tot",
                "effect_visual_1_ovr","effect_visual_1_vis","effect_visual_1_tot",
                "music_1_comp","music_1_perf","music_1_tot",
                "visual_1_comp","visual_1_perf","visual_1_tot",
                "sub_total","penalties","total"
            ]
            # judge name columns
            df["effect_music_1_judge"]  = header1[2]
            df["effect_visual_1_judge"] = header1[5]
            df["music_1_judge"]         = header1[8]
            df["visual_1_judge"]        = header1[11]
            df["effect_music_2_judge"]  = None #none since there are no 2nd panel judges
            df["effect_visual_2_judge"] = None
            df["music_2_judge"]         = None
            df["visual_2_judge"]        = None
        
        # add in the class and date columns

        df["class"] = event_class

        df["date"] = date_lookup.get(url, None)

        #adding date
        df = df.reindex(columns = master_col + ["date"])

        cleaned_tables.append(df)

scores_and_rank_df = pd.concat(cleaned_tables, ignore_index=True)

scores_and_rank_df

scores_and_rank_df["date"] = pd.to_datetime(scores_and_rank_df["date"], errors="coerce").dt.date

# splitting the scores and ranks
skip_cols = [
    "group","location",
    "effect_music_1_judge","effect_music_2_judge",
    "effect_visual_1_judge","effect_visual_2_judge",
    "music_1_judge","music_2_judge",
    "visual_1_judge","visual_2_judge",
    "class", "date"
]
combined_scores = scores_and_rank_df.copy()
combined_ranks  = scores_and_rank_df.copy()

for col in scores_and_rank_df.columns:
    if col not in skip_cols:
        if scores_and_rank_df[col].dtype == object:

            combined_scores[col] = (
                scores_and_rank_df[col]
                .str.extract(r'^([\d.]+)', expand=False)
                .astype(float)
            )

            combined_ranks[col] = (
                scores_and_rank_df[col]
                .str.extract(r'\((\d+)\)', expand=False)
                .astype(float)
            )
combined_scores
combined_ranks
```